name: Weather Api CI

on:
  workflow_dispatch:
  push:
   branches:
      - main


env:
  AZURE_WEBAPP_NAME: "tapweatherapi"
  AZURE_WEBAPP_PACKAGE_PATH: "./Weatherapi/publish"
  DOTNET_VERSION: "8.0.410"
  SOLUTION_PATH: "./weatherapi/weatherapi.sln"
  API_PROJECT_PATH: "/TAP-Whether-Api/weatherapi"
  PUBLISH_DIR: "./publish"


jobs:
  build:
     name: Build
     runs-on: ubuntu-latest

     steps:
       - uses : actions/checkout@v4
  
       - name : Setup .NET
         uses : actions/setup-dotnet@v4
         with :
               dotnet-version : ${{env.DOTNET_VERSION}}

       - name : Run MSBuild Help
         run : dotnet msbuild -help
        
       - name : Restore dependencies
         run :  dotnet restore /TAP-Whether-Api/weatherapi/weatherapi/weatherapi.sln --verbosity detailed

       - name : Build
         run :  dotnet restore ${{env.SOLUTION_PATH}}  --configuration Release --no-restore

       - name : Test
         run :  dotnet test ${{env.SOLUTION_PATH}}  --configuration Release --no-restore --no-build --verbosity normal

       - name : Publish
         run :  dotnet publish ${{env.API_PROJECT_PATH}}  --configuration Release --no-restore --no-build --property:PublishDir=${{env.PUBLISH_DIR}}

       - name : Publish Artifacts
         uses : actions/upload-artifact@v4
         with :
           name : webapp
           path : ${{env.AZURE_WEBAPP_PACKAGE_PATH}}
  
  
  deploy:
         name: Deploy to Azure
         runs-on: ubuntu-latest
         needs: [build]

         steps:    
            - name : Download artifact from build job 
              uses : actions/download-artifact@v4
              with :
                 name : webapp
                 path : ${{env.AZURE_WEBAPP_PACKAGE_PATH}}

             
            - name : Deploy
              uses : azure/webapp-deploy@v2
              with :
                 app-name : ${{env.AZURE_WEBAPP_NAME}}
                 publish-profile : ${{secrets.AZURE_WEBAPP_PUBLISH_PROFILE}}
                 package:  ${{env.AZURE_WEBAPP_PACKAGE_PATH}}
  
